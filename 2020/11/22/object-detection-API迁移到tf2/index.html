<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="object detection API迁移到tf2"><meta name="keywords" content="tensorflow,人工智能,物体识别"><meta name="author" content="Lacus Rinz"><meta name="copyright" content="Lacus Rinz"><title>object detection API迁移到tf2 | Rinz's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#目标"><span class="toc-number">1.</span> <span class="toc-text"> 目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#环境"><span class="toc-number">2.</span> <span class="toc-text"> 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据准备"><span class="toc-number">3.</span> <span class="toc-text"> 数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置环境"><span class="toc-number">4.</span> <span class="toc-text"> 配置环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写pipeline文件"><span class="toc-number">5.</span> <span class="toc-text"> 编写Pipeline文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始训练"><span class="toc-number">6.</span> <span class="toc-text"> 开始训练</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#训练过程与结果"><span class="toc-number">7.</span> <span class="toc-text"> 训练过程与结果</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/avatar.JPG"></div><div class="author-info__name text-center">Lacus Rinz</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">14</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Rinz's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">object detection API迁移到tf2</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-22</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%BA%94%E7%94%A8/">机器学习应用</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="目标"><a class="markdownIt-Anchor" href="#目标"></a> 目标</h3>
<p>随着tf2的发布，object detection API也已经迁移到了tf2上，有朋友正好要开始学习应用目标检测，问我有没有tf2的教程，于是决定决定把原来tf1.15上的使用自定义数据集在本地显卡上测试的代码迁移到tf2上，并且使用Colaboratory来运行，免去了本地环境的搭建。</p>
<a id="more"></a>
<h3 id="环境"><a class="markdownIt-Anchor" href="#环境"></a> 环境</h3>
<p>tensorflow 2.3<br />
Colaboratory with GPU</p>
<h3 id="数据准备"><a class="markdownIt-Anchor" href="#数据准备"></a> 数据准备</h3>
<ol>
<li>
<p>准备数据集<br />
数据集与原文使用的一致，继续沿用</p>
</li>
<li>
<p>获取tf2的预训练模型<br />
<a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" target="_blank" rel="noopener">TensorFlow 2 Model Zoo</a><br />
在ZOO中选择需要的模型，这里我沿用之前文章类似的<code>SSD MobileNet V2 FPNLite 320x320</code></p>
</li>
</ol>
<h3 id="配置环境"><a class="markdownIt-Anchor" href="#配置环境"></a> 配置环境</h3>
<ul>
<li>关于tf和GPU<br />
Colaboratory自带最新的tf版本，可以通过import后<code>print(tf.__version__)</code>查看当前版本，无需额外安装；<br />
通过<code>修改-&gt;笔记本设置</code>，选择<code>硬件加速器GPU</code>即可使用Colaboratory自带的GPU资源。</li>
</ul>
<blockquote>
<p>Colaboratory的GPU资源大概只能连续使用1个小时，然后会挂起，使用时注意，1个小时用来学习测试足以</p>
</blockquote>
<ul>
<li>安装 Object Detection API</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pathlib</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clone the tensorflow models repository if it doesn't already exist</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"models"</span> <span class="keyword">in</span> pathlib.Path.cwd().parts:</span><br><span class="line">  <span class="keyword">while</span> <span class="string">"models"</span> <span class="keyword">in</span> pathlib.Path.cwd().parts:</span><br><span class="line">    os.chdir(<span class="string">'..'</span>)</span><br><span class="line"><span class="keyword">elif</span> <span class="keyword">not</span> pathlib.Path(<span class="string">'models'</span>).exists():</span><br><span class="line">  !git clone --depth <span class="number">1</span> https://github.com/tensorflow/models</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install the Object Detection API</span></span><br><span class="line">%%bash</span><br><span class="line"><span class="built_in">cd</span> models/research/</span><br><span class="line">protoc object_detection/protos/*.proto --python_out=.</span><br><span class="line">cp object_detection/packages/tf2/setup.py .</span><br><span class="line">python -m pip install .</span><br></pre></td></tr></table></figure>
<p>Object Detection API会安装在虚拟机的目录下，所以后面我们要把我们的资源（先存储到Google Drive里）都拷贝到虚拟机对应的目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">%%bash</span><br><span class="line">ls</span><br><span class="line">mkdir models/research/abc</span><br><span class="line">mkdir models/research/abc/data</span><br><span class="line"></span><br><span class="line"><span class="comment">#drive/My\ Drive/Object\ Detection/my\ OD/是我Google Drive里的目录，data里存的是训练数据，拷贝到research对应的位置下</span></span><br><span class="line"><span class="built_in">cd</span> drive/My\ Drive/Object\ Detection/my\ OD/</span><br><span class="line">ls</span><br><span class="line">cp -rf data/* /content/models/research/abc/data</span><br><span class="line"></span><br><span class="line">mkdir models/research/abc/models</span><br><span class="line"><span class="built_in">cd</span> drive/My\ Drive/Object\ Detection/my\ OD/models</span><br><span class="line"><span class="comment">#这里将Google Drive里存储的刚下载的SSD MobileNet V2 FPNLite 320x320预训练模型解压文件，拷贝到虚拟机中</span></span><br><span class="line">ls</span><br><span class="line">cp -rf * /content/models/research/abc/models</span><br></pre></td></tr></table></figure>
<ul>
<li>测试Object Detection API</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%%bash</span><br><span class="line"><span class="built_in">cd</span> models/research/</span><br><span class="line">python object_detection/builders/model_builder_tf2_test.py</span><br></pre></td></tr></table></figure>
<p>测试通过如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_create_ssd_models_from_config): 31.47s</span><br><span class="line">I1122 03:06:47.900097 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_create_ssd_models_from_config): 31.47s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_create_ssd_models_from_config</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_invalid_faster_rcnn_batchnorm_update</span><br><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_invalid_faster_rcnn_batchnorm_update): 0.0s</span><br><span class="line">I1122 03:06:47.908242 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_invalid_faster_rcnn_batchnorm_update): 0.0s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_invalid_faster_rcnn_batchnorm_update</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_invalid_first_stage_nms_iou_threshold</span><br><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_invalid_first_stage_nms_iou_threshold): 0.0s</span><br><span class="line">I1122 03:06:47.910503 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_invalid_first_stage_nms_iou_threshold): 0.0s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_invalid_first_stage_nms_iou_threshold</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_invalid_model_config_proto</span><br><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_invalid_model_config_proto): 0.0s</span><br><span class="line">I1122 03:06:47.911248 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_invalid_model_config_proto): 0.0s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_invalid_model_config_proto</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_invalid_second_stage_batch_size</span><br><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_invalid_second_stage_batch_size): 0.0s</span><br><span class="line">I1122 03:06:47.913010 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_invalid_second_stage_batch_size): 0.0s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_invalid_second_stage_batch_size</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_session</span><br><span class="line">[  SKIPPED ] ModelBuilderTF2Test.test_session</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_unknown_faster_rcnn_feature_extractor</span><br><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_unknown_faster_rcnn_feature_extractor): 0.0s</span><br><span class="line">I1122 03:06:47.914866 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_unknown_faster_rcnn_feature_extractor): 0.0s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_unknown_faster_rcnn_feature_extractor</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_unknown_meta_architecture</span><br><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_unknown_meta_architecture): 0.0s</span><br><span class="line">I1122 03:06:47.915547 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_unknown_meta_architecture): 0.0s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_unknown_meta_architecture</span><br><span class="line">[ RUN      ] ModelBuilderTF2Test.test_unknown_ssd_feature_extractor</span><br><span class="line">INFO:tensorflow:time(__main__.ModelBuilderTF2Test.test_unknown_ssd_feature_extractor): 0.0s</span><br><span class="line">I1122 03:06:47.916894 140077263148928 test_util.py:1973] time(__main__.ModelBuilderTF2Test.test_unknown_ssd_feature_extractor): 0.0s</span><br><span class="line">[       OK ] ModelBuilderTF2Test.test_unknown_ssd_feature_extractor</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Ran 20 tests in 42.757s</span><br><span class="line"></span><br><span class="line">OK (skipped&#x3D;1)</span><br></pre></td></tr></table></figure>
<h3 id="编写pipeline文件"><a class="markdownIt-Anchor" href="#编写pipeline文件"></a> 编写Pipeline文件</h3>
<p>Pipeline是tf使用的一种配置文件，用于配置训练过程，在我们下载的<code>SSD MobileNet V2 FPNLite 320x320</code>文件夹中自带了一个，但直接使用会有问题，这里改写后内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"># SSD with Mobilenet v2 FPN-lite (go&#x2F;fpn-lite) feature extractor, shared box</span><br><span class="line"># predictor and focal loss (a mobile version of Retinanet).</span><br><span class="line"># Retinanet: see Lin et al, https:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;1708.02002</span><br><span class="line"># Trained on COCO, initialized from Imagenet classification checkpoint</span><br><span class="line"># Train on TPU-8</span><br><span class="line">#</span><br><span class="line"># Achieves 22.2 mAP on COCO17 Val</span><br><span class="line"></span><br><span class="line">model &#123;</span><br><span class="line">  ssd &#123;</span><br><span class="line">    inplace_batchnorm_update: true</span><br><span class="line">    freeze_batchnorm: false</span><br><span class="line">    num_classes: 6</span><br><span class="line">    box_coder &#123;</span><br><span class="line">      faster_rcnn_box_coder &#123;</span><br><span class="line">        y_scale: 10.0</span><br><span class="line">        x_scale: 10.0</span><br><span class="line">        height_scale: 5.0</span><br><span class="line">        width_scale: 5.0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    matcher &#123;</span><br><span class="line">      argmax_matcher &#123;</span><br><span class="line">        matched_threshold: 0.5</span><br><span class="line">        unmatched_threshold: 0.5</span><br><span class="line">        ignore_thresholds: false</span><br><span class="line">        negatives_lower_than_unmatched: true</span><br><span class="line">        force_match_for_each_row: true</span><br><span class="line">        use_matmul_gather: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    similarity_calculator &#123;</span><br><span class="line">      iou_similarity &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    encode_background_as_zeros: true</span><br><span class="line">    anchor_generator &#123;</span><br><span class="line">      multiscale_anchor_generator &#123;</span><br><span class="line">        min_level: 3</span><br><span class="line">        max_level: 7</span><br><span class="line">        anchor_scale: 4.0</span><br><span class="line">        aspect_ratios: [1.0, 2.0, 0.5]</span><br><span class="line">        scales_per_octave: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    image_resizer &#123;</span><br><span class="line">      fixed_shape_resizer &#123;</span><br><span class="line">        height: 320</span><br><span class="line">        width: 320</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    box_predictor &#123;</span><br><span class="line">      weight_shared_convolutional_box_predictor &#123;</span><br><span class="line">        depth: 128</span><br><span class="line">        class_prediction_bias_init: -4.6</span><br><span class="line">        conv_hyperparams &#123;</span><br><span class="line">          activation: RELU_6,</span><br><span class="line">          regularizer &#123;</span><br><span class="line">            l2_regularizer &#123;</span><br><span class="line">              weight: 0.00004</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          initializer &#123;</span><br><span class="line">            random_normal_initializer &#123;</span><br><span class="line">              stddev: 0.01</span><br><span class="line">              mean: 0.0</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          batch_norm &#123;</span><br><span class="line">            scale: true,</span><br><span class="line">            decay: 0.997,</span><br><span class="line">            epsilon: 0.001,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        num_layers_before_predictor: 4</span><br><span class="line">        share_prediction_tower: true</span><br><span class="line">        use_depthwise: true</span><br><span class="line">        kernel_size: 3</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    feature_extractor &#123;</span><br><span class="line">      type: &#39;ssd_mobilenet_v2_fpn_keras&#39;</span><br><span class="line">      use_depthwise: true</span><br><span class="line">      fpn &#123;</span><br><span class="line">        min_level: 3</span><br><span class="line">        max_level: 7</span><br><span class="line">        additional_layer_depth: 128</span><br><span class="line">      &#125;</span><br><span class="line">      min_depth: 16</span><br><span class="line">      depth_multiplier: 1.0</span><br><span class="line">      conv_hyperparams &#123;</span><br><span class="line">        activation: RELU_6,</span><br><span class="line">        regularizer &#123;</span><br><span class="line">          l2_regularizer &#123;</span><br><span class="line">            weight: 0.00004</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        initializer &#123;</span><br><span class="line">          random_normal_initializer &#123;</span><br><span class="line">            stddev: 0.01</span><br><span class="line">            mean: 0.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        batch_norm &#123;</span><br><span class="line">          scale: true,</span><br><span class="line">          decay: 0.997,</span><br><span class="line">          epsilon: 0.001,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      override_base_feature_extractor_hyperparams: true</span><br><span class="line">    &#125;</span><br><span class="line">    loss &#123;</span><br><span class="line">      classification_loss &#123;</span><br><span class="line">        weighted_sigmoid_focal &#123;</span><br><span class="line">          alpha: 0.25</span><br><span class="line">          gamma: 2.0</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      localization_loss &#123;</span><br><span class="line">        weighted_smooth_l1 &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      classification_weight: 1.0</span><br><span class="line">      localization_weight: 1.0</span><br><span class="line">    &#125;</span><br><span class="line">    normalize_loss_by_num_matches: true</span><br><span class="line">    normalize_loc_loss_by_codesize: true</span><br><span class="line">    post_processing &#123;</span><br><span class="line">      batch_non_max_suppression &#123;</span><br><span class="line">        score_threshold: 1e-8</span><br><span class="line">        iou_threshold: 0.6</span><br><span class="line">        max_detections_per_class: 100</span><br><span class="line">        max_total_detections: 100</span><br><span class="line">      &#125;</span><br><span class="line">      score_converter: SIGMOID</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">train_config: &#123;</span><br><span class="line">  fine_tune_checkpoint_version: V2</span><br><span class="line">  fine_tune_checkpoint: &quot;&#x2F;content&#x2F;models&#x2F;research&#x2F;abc&#x2F;models&#x2F;ssd_mobilenet_v2_fpnlite_320x320_coco17_tpu-8&#x2F;cp&#x2F;ckpt-0&quot;</span><br><span class="line">  fine_tune_checkpoint_type: &quot;detection&quot;</span><br><span class="line">  batch_size: 16</span><br><span class="line">  sync_replicas: true</span><br><span class="line">  startup_delay_steps: 0</span><br><span class="line">  replicas_to_aggregate: 8</span><br><span class="line">  num_steps: 10000</span><br><span class="line">  data_augmentation_options &#123;</span><br><span class="line">    random_horizontal_flip &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  data_augmentation_options &#123;</span><br><span class="line">    random_crop_image &#123;</span><br><span class="line">      min_object_covered: 0.0</span><br><span class="line">      min_aspect_ratio: 0.75</span><br><span class="line">      max_aspect_ratio: 3.0</span><br><span class="line">      min_area: 0.75</span><br><span class="line">      max_area: 1.0</span><br><span class="line">      overlap_thresh: 0.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  optimizer &#123;</span><br><span class="line">    momentum_optimizer: &#123;</span><br><span class="line">      learning_rate: &#123;</span><br><span class="line">        cosine_decay_learning_rate &#123;</span><br><span class="line">          learning_rate_base: .08</span><br><span class="line">          total_steps: 10000</span><br><span class="line">          warmup_learning_rate: .026666</span><br><span class="line">          warmup_steps: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      momentum_optimizer_value: 0.9</span><br><span class="line">    &#125;</span><br><span class="line">    use_moving_average: false</span><br><span class="line">  &#125;</span><br><span class="line">  max_number_of_boxes: 100</span><br><span class="line">  unpad_groundtruth_tensors: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">train_input_reader: &#123;</span><br><span class="line">  label_map_path: &quot;&#x2F;content&#x2F;models&#x2F;research&#x2F;abc&#x2F;data&#x2F;abc_label_map.pbtxt&quot;</span><br><span class="line">  tf_record_input_reader &#123;</span><br><span class="line">    input_path: &quot;&#x2F;content&#x2F;models&#x2F;research&#x2F;abc&#x2F;data&#x2F;abc_train*&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">eval_config: &#123;</span><br><span class="line">  metrics_set: &quot;coco_detection_metrics&quot;</span><br><span class="line">  use_moving_averages: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">eval_input_reader: &#123;</span><br><span class="line">  label_map_path: &quot;&#x2F;content&#x2F;models&#x2F;research&#x2F;abc&#x2F;data&#x2F;abc_label_map.pbtxt&quot;</span><br><span class="line">  shuffle: false</span><br><span class="line">  num_epochs: 1</span><br><span class="line">  tf_record_input_reader &#123;</span><br><span class="line">    input_path: &quot;&#x2F;content&#x2F;models&#x2F;research&#x2F;abc&#x2F;data&#x2F;abc_val.record*&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一个重要改动是<code>fine_tune_checkpoint_type</code>需要设置成<code>detection</code>。</p>
<h3 id="开始训练"><a class="markdownIt-Anchor" href="#开始训练"></a> 开始训练</h3>
<ul>
<li>使用tensorboard监控训练进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%reload_ext tensorboard</span><br><span class="line">%tensorboard --logdir /content/models/research/abc/models/ssd_mobilenet_v2_fpnlite_320x320_coco17_tpu-8/</span><br></pre></td></tr></table></figure>
<p>注意一定要先执行tensorboard命令，命令执行后是非持续性的，tensorboard启动后就会一直存在，并且不会占用Colaboratory，这时候可以再去启动训练程序，这样训练过程中写的日志可以被tensorboard不断读取。</p>
<ul>
<li>执行训练程序</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%%bash</span><br><span class="line"><span class="built_in">cd</span> models/research/</span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line"></span><br><span class="line">python object_detection/model_main_tf2.py \</span><br><span class="line">    --pipeline_config_path=/content/models/research/abc/models/ssd_mobilenet_v2_fpnlite_320x320_coco17_tpu-8/pipeline.config \</span><br><span class="line">    --model_dir=/content/models/research/abc/models/ssd_mobilenet_v2_fpnlite_320x320_coco17_tpu-8/ \</span><br><span class="line">    --alsologtostderr</span><br></pre></td></tr></table></figure>
<p>与tf1.15相比执行文件换成了<code>model_main_tf2.py</code>，其他设置都一样。</p>
<p>但是由于迁移只做了一些主要功能的tf2适配，与tf1.15相比，不能设置每隔多少train做一次eval，导致只能训练完成后执行一次eval，不能直观看到eval的变化。</p>
<h3 id="训练过程与结果"><a class="markdownIt-Anchor" href="#训练过程与结果"></a> 训练过程与结果</h3>
<p><img src="loss.png" alt="loss.png" /><br />
观察tensorboard可以看到在0-5000步过程中loss平稳下降</p>
<p><img src="mAP.png" alt="mAP.png" /><br />
在5000步时eval结果mAP达到82%</p>
<p>最后抽查eval过程中的图片结果，左侧为训练图片，右侧为检测结果</p>
<p><img src="eval_side_by_side_1.png" alt="eval_side_by_side_1.png" /></p>
<p><img src="eval_side_by_side_2.png" alt="eval_side_by_side_2.png" /></p>
<p>效果OK</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Lacus Rinz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lacusrinz.github.com/2020/11/22/object-detection-API%E8%BF%81%E7%A7%BB%E5%88%B0tf2/">http://lacusrinz.github.com/2020/11/22/object-detection-API%E8%BF%81%E7%A7%BB%E5%88%B0tf2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lacusrinz.github.com">Rinz's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/tensorflow/">tensorflow</a><a class="post-meta__tags" href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">人工智能</a><a class="post-meta__tags" href="/tags/%E7%89%A9%E4%BD%93%E8%AF%86%E5%88%AB/">物体识别</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/alipay.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/03/06/hanLP1/"><i class="fa fa-chevron-left">  </i><span>使用hanLP进行自定义NER训练</span></a></div><div class="next-post pull-right"><a href="/2020/05/30/operation2/"><span>运营设施建设——用户画像</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By Lacus Rinz</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>